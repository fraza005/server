import signal
import sys
import socket
import argparse

import setuptools

parser = argparse.ArgumentParser()
parser.add_argument('port', type = int)
args = parser.parse_args()

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

def sigHandle(sig,frame):
    sys.exit(0)


def clientAcc():
    # Accept connection from user
    userSocket = sock.accept()
    userAddress = sock.accept()

    # Send accio message
    userSocket.send(bytes('accio\r\n', 'b""'))
    userAddress.send(bytes('accio\r\n', 'b""'))
    userSocket.settimeout(10)

try:
    sock.bind(('0.0.0.0',args.port))
except:
    sys.stderr.write('ERROR: INCORRECT PORT')
    exit(7)

sock.listen(10)
sock.settimeout(10)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF, 5000)

while True:
    clientAcc()
    signal.signal(signal.SIGINT, sigHandle())
    signal.signal(signal.SIGTERM, sigHandle())
    while True:
        try:
            userInput = b""(clientAcc().userSocket.recv(15))
        except socket.timeout:
            sys.stderr.write('ERROR')

        received = received + len(userInput)

    clientAcc().userSocket.close()
    sys.stdout.flush()


